---
description: コーディングガイドライン - 実装・レビュー時のルール
globs:
alwaysApply: true
---

必ず日本語で回答してください。

## 基本ルール

### 実装・レビュー時に気を付けること

- CPU, メモリ等のパフォーマンス面に問題あるか
- 誤字脱字はあるか
- セキュリティ的な問題はあるか
- コメントやドキュメントは必ず日本語で記述する

### Serena MCP使用ガイドライン

- **複雑なコード解析**や**アーキテクチャ理解**が必要な場面では積極的にSerenaを使用する
- **Serena推奨場面**：
  - コードベース全体の構造理解
  - シンボル間の参照関係調査
  - クラス・関数・変数の使用箇所特定
  - ファイル間の依存関係分析
  - 大規模リファクタリングの影響範囲調査
  - 設計パターンの実装箇所探索
  - バグの原因となる関連コード特定
- **通常ツール推奨場面**：
  - 単純なファイル読み込み・編集
  - 既知のファイル・関数への直接的な変更
  - シンプルな文字列検索・置換
- Serena MCPの機能を活用して効率的で正確なコード分析を心がける

### 実装完了後の動作

Cursor コマンド `/all-commit` を利用してブランチ作成 -> コミット -> PR作成を行うかをユーザーに確認する。

## アーキテクチャ設計の要点

- **依存逆転（DIP）**: ポート（インターフェース）で抽象化、アダプタで注入。ビジネスロジックは外部の実装に依存しない
- **Functional Core, Imperative Shell**: コアは純粋関数と不変データ、I/Oとフレームワーク依存はシェルに隔離
- **テスト容易性**: ポート化、テストダブル（InMemory/Fake）、契約テストで振る舞いを保証
- **Astroコンポーネント**: 表示専用、ビジネスロジックはappレイヤーへ委譲。データ取得はポート経由で注入
- **副作用の隔離**: ファイルI/O、ネットワーク、プロセス実行はアダプタに集約

詳細: [architecture.md](../../docs/coding-guidelines/architecture.md)

## Astro/TypeScriptの要点

- **TypeScript厳格モード**: `strict: true` を維持、テストからインターフェースを導出、依存の方向を明確化（ドメイン → アプリ → アダプタ）
- **型安全性**: `any`型を回避、型アサーションは最小限、型ガードを適切に使用
- **nullチェック**: オプショナルチェーン（`?.`）やnull合体演算子（`??`）を適切に使用、非nullアサーション（`!`）は最小限
- **Astroコンポーネント**: サーバー/クライアントの境界を明確化、クライアントサイドコンポーネントは必要最小限に
- **インポート/エクスポート**: 型のみのインポートは `import type` を使用

詳細: [astro-typescript.md](../../docs/coding-guidelines/astro-typescript.md)

## セキュリティの要点

- **XSS対策**: Astroの自動エスケープを活用、`set:html` は信頼できるデータのみ使用、ユーザー入力は必ずサニタイズ
- **環境変数**: 機密情報は `PUBLIC_` プレフィックスなし、`import.meta.env` の使用が適切か確認
- **入力値検証**: サーバーサイドでも検証を実施、スキーマ検証（zod等）を活用、外部APIからのレスポンスも検証
- **機密情報**: ハードコーディングを回避、`.env` ファイルは `.gitignore` に含める
- **依存関係**: `pnpm audit` で脆弱性を確認・修正、定期的に更新

詳細: [security.md](../../docs/coding-guidelines/security.md)

## コード品質の要点

- **可読性**: 意味のある命名、適切なコメント（日本語）、複雑なロジックは適切に分割
- **保守性**: 重複コードを排除（DRY原則）、マジックナンバーは定数化、設定値は外部化
- **パフォーマンス**: 不要な再レンダリングを回避、メモ化を適切に使用、大きなデータの処理を最適化
- **エラーハンドリング**: エラーを適切にハンドリング、エラーメッセージを適切に表示、ログを適切に記録、Result型の使用を検討

詳細: [code-quality.md](../../docs/coding-guidelines/code-quality.md)

## 関連ドキュメント

- **[AGENTS.md](../../AGENTS.md)**: エージェント開発ガイド（TDD、テスト設計、開発サイクルなど）
- **[docs/coding-guidelines/](../../docs/coding-guidelines/)**: 詳細ガイドライン（アーキテクチャ、Astro/TypeScript、セキュリティ、コード品質）
