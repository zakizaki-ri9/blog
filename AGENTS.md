# エージェント開発ガイド

## 全エージェント共通ルール

このセクションは、すべてのエージェントが参照すべき共通のルールとガイドラインをまとめています。

### 実装・レビュー時に気を付けること

- CPU, メモリ等のパフォーマンス面に問題あるか
- 誤字脱字はあるか
- セキュリティ的な問題はあるか
- コメントやドキュメントは必ず日本語で記述する

### Serena MCP使用ガイドライン

- **複雑なコード解析**や**アーキテクチャ理解**が必要な場面では積極的にSerenaを使用する
- **Serena推奨場面**：
  - コードベース全体の構造理解
  - シンボル間の参照関係調査
  - クラス・関数・変数の使用箇所特定
  - ファイル間の依存関係分析
  - 大規模リファクタリングの影響範囲調査
  - 設計パターンの実装箇所探索
  - バグの原因となる関連コード特定
- **通常ツール推奨場面**：
  - 単純なファイル読み込み・編集
  - 既知のファイル・関数への直接的な変更
  - シンプルな文字列検索・置換
- Serena MCPの機能を活用して効率的で正確なコード分析を心がける

### 実装完了後の動作

Cursor コマンド `/all-commit` を利用してブランチ作成 -> コミット -> PR作成を行うかをユーザーに確認する。

## 目的と前提
- このプロジェクトは Astro（TypeScript）によるブログサイトであり、エージェントはタスクごとにテスト駆動で安全に改善します。
- パッケージマネージャーは `pnpm`、フォーマット・静的検査は既存の ESLint 設定を尊重してください。
- 開発中に疑問があれば必ずテストとドキュメントで意図を可視化し、状況を説明するログを残します。
- ユーザー価値から逆算し、テストを「仕様の例示」として扱うことで使いやすさを保証します。

## t-wada流TDDの基本原則
- `Red → Green → Refactor` のループを厳守し、テストを先に書いて失敗（Red）を必ず確認します。
- テストリスト（Test Todo）を維持し、失敗テストと保留項目を明文化して作業順序を整理します。
- 最小限の仮実装で緑化し、追加の失敗テストで期待を三角測量し、最後に明白な実装へ至る三段階を踏んでください。
- 振る舞いを一歩ずつ育てるベイビーステップを徹底し、1 テストケースずつリズムよく改善します。
- リファクタリング時はテストを安全網としてコードの重複排除や命名改善を行い、動作仕様を変えないことを確認します。

## タスク開始前のチェック
- 依頼内容を受け取ったら、期待される振る舞いと完了条件を日本語でメモし、テストリストに落とし込みます。
- **Serena メモリの活用**: 開発や調査を行う際は、まず既存の Serena メモリを確認し、古い情報があれば更新してから作業を進めます。メモリに記録された過去の知見や設計決定を参照することで、一貫性のある開発を実現します。
- 現状のテストや関連ファイルを確認し、変更が及ぶ範囲の依存を把握します。
- 設計上の仮説（どのレイヤーにテストを書くか、使用するテストダブルなど）を明文化します。

## エージェントの開発サイクル
1. **Red**: `pnpm` でテスト実行環境を整備し、まず落ちるテストを追加して失敗を確認します。
2. **Green**: 仮実装で最小限の緑化を行い、必要に応じてテストダブルやスタブを使います。
3. **Triangulate**: 仕様の曖昧さを追加テストで明確化し、振る舞いを固定化します。
4. **Refactor**: コードとテストの重複排除、命名改善、抽象化を行い、すべてのテストを再実行して安全性を担保します。
5. **記録**: 実施したテスト、決定事項、未解決課題をコメントまたはドキュメントに追記します。重要な設計決定や知見は Serena メモリにも記録し、今後の開発で参照できるようにします。

## テスト設計とレイヤー
- 単体テストは `Vitest` 採用を前提とし、純粋な関数やユーティリティを対象に高速なフィードバックを確保します。
- コンポーネントやテンプレートには Astro のレンダリングテスト（`@astrojs/test` など）を利用し、SSR/SSG の出力を検証します。
- 統合・E2E テストでは `Playwright` などを活用し、ページ表示や RSS 生成などユーザー視点で重要な経路を押さえます。
- テストダブル（スタブ／モック／フェイク）は外部 API や I/O を分離するために使用し、振る舞いを固定します。
- 回帰防止としてバグ修正時は必ず再現テストを追加してから修正します。

## コーディングと設計の指針

コーディングと設計に関する詳細なガイドラインは、[`docs/coding-guidelines/`](../docs/coding-guidelines/) ディレクトリにまとめられています。

### 主要なドキュメント

- **[アーキテクチャ設計](../docs/coding-guidelines/architecture.md)**: テスト容易性を確保するアーキテクチャ設計原則、推奨ディレクトリ構成、ポート例、テストダブル運用など
- **[Astro/TypeScript](../docs/coding-guidelines/astro-typescript.md)**: Astro/TypeScript に特化したコーディングガイドライン
- **[セキュリティ](../docs/coding-guidelines/security.md)**: セキュリティチェック項目とベストプラクティス
- **[コード品質](../docs/coding-guidelines/code-quality.md)**: コード品質チェック項目とレビュー時の注意事項

詳細は各ドキュメントを参照してください。

## 仕上げと品質ゲート
- `pnpm lint` と全テストを完走させ、失敗テストがないことを確認します。
- 変更点・テスト結果・残課題をタスクメモに記録し、次のエージェントが再現できるようにします。
- **Serena メモリの更新**: 作業完了時に、新たに得られた知見や設計決定を Serena メモリに記録し、古い情報があれば更新します。
- 未対応のテストTodoは明確に残し、優先順位を示します。
- コードとテストが同時に読めるよう、複雑な箇所には簡潔なコメントまたは補助ドキュメントを添えます。
