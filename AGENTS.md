# エージェント開発ガイド（t-wada流TDD）

## 目的と前提
- このプロジェクトは Astro（TypeScript）によるブログサイトであり、エージェントはタスクごとにテスト駆動で安全に改善します。
- パッケージマネージャーは `pnpm`、フォーマット・静的検査は既存の ESLint 設定を尊重してください。
- 開発中に疑問があれば必ずテストとドキュメントで意図を可視化し、状況を説明するログを残します。
- ユーザー価値から逆算し、テストを「仕様の例示」として扱うことで使いやすさを保証します。

## t-wada流TDDの基本原則
- `Red → Green → Refactor` のループを厳守し、テストを先に書いて失敗（Red）を必ず確認します。
- テストリスト（Test Todo）を維持し、失敗テストと保留項目を明文化して作業順序を整理します。
- 最小限の仮実装で緑化し、追加の失敗テストで期待を三角測量し、最後に明白な実装へ至る三段階を踏んでください。
- 振る舞いを一歩ずつ育てるベイビーステップを徹底し、1 テストケースずつリズムよく改善します。
- リファクタリング時はテストを安全網としてコードの重複排除や命名改善を行い、動作仕様を変えないことを確認します。

## タスク開始前のチェック
- 依頼内容を受け取ったら、期待される振る舞いと完了条件を日本語でメモし、テストリストに落とし込みます。
- 現状のテストや関連ファイルを確認し、変更が及ぶ範囲の依存を把握します。
- 設計上の仮説（どのレイヤーにテストを書くか、使用するテストダブルなど）を明文化します。

## エージェントの開発サイクル
1. **Red**: `pnpm` でテスト実行環境を整備し、まず落ちるテストを追加して失敗を確認します。
2. **Green**: 仮実装で最小限の緑化を行い、必要に応じてテストダブルやスタブを使います。
3. **Triangulate**: 仕様の曖昧さを追加テストで明確化し、振る舞いを固定化します。
4. **Refactor**: コードとテストの重複排除、命名改善、抽象化を行い、すべてのテストを再実行して安全性を担保します。
5. **記録**: 実施したテスト、決定事項、未解決課題をコメントまたはドキュメントに追記します。

## テスト設計とレイヤー
- 単体テストは `Vitest` 採用を前提とし、純粋な関数やユーティリティを対象に高速なフィードバックを確保します。
- コンポーネントやテンプレートには Astro のレンダリングテスト（`@astrojs/test` など）を利用し、SSR/SSG の出力を検証します。
- 統合・E2E テストでは `Playwright` などを活用し、ページ表示や RSS 生成などユーザー視点で重要な経路を押さえます。
- テストダブル（スタブ／モック／フェイク）は外部 API や I/O を分離するために使用し、振る舞いを固定します。
- 回帰防止としてバグ修正時は必ず再現テストを追加してから修正します。

## コーディングと設計の指針
- TypeScript の厳格モードを維持しつつ、テストからインターフェースを導出して依存の向きを明確化します。
- テストを最小の仕様書とみなし、振る舞いの期待（例・反例）をテスト名とアサーションに埋め込みます。
- ファイル構造・命名規則・ESLint ルールは既存メモ（`code_style_conventions`）に従い、ドメイン単位で関心を分離します。
- 仕様が曖昧な場合は「誤りに対して合否が判断できるテスト」を先に追加し、意図をコード化してから実装を変えます。
- リファクタリング時はテスト網で守られている範囲だけを対象にし、不要な最適化や広範囲の変更を避けてください。

## テスト容易性を確保するアーキテクチャ
- 依存逆転（DIP）
  - ドメイン/アプリ層が上位。外部世界（FS/HTTP/画像生成/検索）はポート（インターフェース）で抽象化し、具体はアダプタで注入します。
- Functional Core, Imperative Shell
  - コアは副作用ゼロの純粋関数と不変データで構成。I/O とフレームワーク依存は薄いシェルへ隔離します。
- 境界の明示と契約
  - 入出力 DTO を定義し、例外・エラーは Result 型（成功/失敗）や明示的エラーに収束。アダプタには契約（contract）テストを用意します。
- 時刻/乱数/設定/環境変数の注入
  - `Clock`・`IdGenerator`・`Env` をポート化し、テスト時に固定化して決定的にします。
- コンポジションルートの一元化
  - 実行環境でのみ依存を束ねる初期化コード（factory/compose）を用意し、テストではインメモリ実装を配線します。

### 推奨ディレクトリ構成（例）
- `src/domain/`：エンティティ、値オブジェクト、ドメインサービス（純粋関数）
- `src/app/`：ユースケース、ポート定義（インターフェース）、DTO
- `src/adapters/`：
  - `content/`（Astro Content Collections 実装）
  - `ogp/`（Satori/Sharp 実装）
  - `rss/`・`sitemap/`（出力生成）
  - `search/`（Pagefind 連携）
  - `http/`・`fs/`・`clock/`・`id/`
- `src/web/`：Astro ページ/コンポーネント（表示専用、ビジネスロジックは `app` 内）
- `src/config/compose.ts`：コンポジションルート（本番配線）
- `tests/`：
  - `unit/`（domain/app の純粋テスト）
  - `contract/`（各アダプタがポート契約を満たすか）
  - `integration/`（ユースケース越境）
  - `e2e/`（Playwright 等で最重要経路）

### 代表ポート例（TypeScript）
```ts
// src/app/ports/content-repo.ts
export interface ContentRepo {
  listPosts(params: { tag?: string }): Promise<PostSummary[]>;
  getPostBySlug(slug: string): Promise<Post | null>;
}

// src/app/ports/ogp.ts
export interface OgpGenerator {
  render(input: OgpInput): Promise<Uint8Array>; // 画像バイト列
}

// src/app/ports/search.ts
export interface SearchIndexer {
  index(docs: SearchDoc[]): Promise<void>;
}

// 共通ポート（決定性確保）
export interface Clock { now(): Date }
export interface IdGenerator { next(): string }
```

### テストダブル運用
- InMemory/Fake 実装を `tests/doubles/` に配置し、ユースケースの速度と決定性を確保します。
- 例：`InMemoryContentRepo`、`FakeOgpGenerator`（一定サイズのダミーバイト列を返す）、`FixedClock`、`FixedIdGenerator`。

### 契約テストの型
- ポートごとに共通テストスイートを用意し、任意のアダプタ実装に対して同一の振る舞いを検証します。
- 例：`content-repo.contract.spec.ts` で「同一タグでのフィルタ」「存在しない slug で null を返す」などを定義。

### Astro との境界ポリシー
- Astro コンポーネントは「表示関心」に限定し、データ整形・絞り込みは `app` ユースケースに委譲します。
- 可能な限り `getStaticPaths`/`get` 相当のデータ取得処理はポート経由で注入し、コンポーネントを関数としてテスト可能にします。

### 副作用の隔離ポイント
- ファイル書込（RSS/サイトマップ/OGP 出力）、ネットワーク、プロセス実行（Pagefind）はアダプタに集約。
- テストではファイルシステムを使わずメモリ/一時ディレクトリを使用し、観察可能な戻り値・イベントで検証します。

### 回帰を防ぐテクニック
- バグ再現テスト → 修正 → 追加の失敗テストで三角測量 → リファクタの順で固定化。
- 表示はスナップショットを最小単位で使用し、過度なドキュメント一括スナップショットは避けます。

## 仕上げと品質ゲート
- `pnpm lint` と全テストを完走させ、失敗テストがないことを確認します。
- 変更点・テスト結果・残課題をタスクメモに記録し、次のエージェントが再現できるようにします。
- 未対応のテストTodoは明確に残し、優先順位を示します。
- コードとテストが同時に読めるよう、複雑な箇所には簡潔なコメントまたは補助ドキュメントを添えます。
