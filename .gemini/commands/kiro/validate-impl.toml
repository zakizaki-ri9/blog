description = "要件、設計、タスクに対して実装を検証する"
prompt = """
<meta>
description: 要件、設計、タスクに対して実装を検証する
argument-hint: [feature-name:$1] [task-numbers:$2]
arguments: {{args}}
</meta>

# 実装検証 (Implementation Validation)

<background_information>
- **ミッション**: 実装が承認された要件、設計、タスクと整合していることを検証する
- **成功基準**:
  - 指定されたすべてのタスクが完了としてマークされている
  - 実装された機能に対してテストが存在し、合格している
  - 要件トレーサビリティが確認されている（EARS要件がカバーされている）
  - 設計構造が実装に反映されている
  - 既存機能にリグレッションがない
</background_information>

<instructions>
## コアタスク
承認された仕様に基づいて、機能およびタスクの実装を検証する。

## 実行ステップ

### 1. 検証ターゲットの検出

**引数が提供されていない場合** (`$1` 空):
- 会話履歴から `/kiro:spec-impl <feature> [tasks]` コマンドをパースする
- 各実行から機能名とタスク番号を抽出する
- 実装されたタスクを機能ごとに集約する
- 検出された実装を報告する（例: "user-auth: 1.1, 1.2, 1.3"）
- 履歴が見つからない場合、完了したタスク `[x]` を持つ機能について `.kiro/specs/` をスキャンする

**機能が提供された場合** (`$1` あり, `$2` 空):
- 指定された機能を使用する
- `.kiro/specs/$1/tasks.md` 内のすべての完了タスク `[x]` を検出する

**機能とタスクの両方が提供された場合** (`$1` と `$2` あり):
- 指定された機能とタスクのみを検証する（例: `user-auth 1.1,1.2`）

### 2. コンテキストのロード

検出された各機能について:
- メタデータのために `.kiro/specs/<feature>/spec.json` を読み込む
- 要件のために `.kiro/specs/<feature>/requirements.md` を読み込む
- 設計構造のために `.kiro/specs/<feature>/design.md` を読み込む
- タスクリストのために `.kiro/specs/<feature>/tasks.md` を読み込む
- **すべてのステアリングコンテキストをロード**: `.kiro/steering/` ディレクトリ全体を読み込む:
  - デフォルトファイル: `structure.md`, `tech.md`, `product.md`
  - すべてのカスタムステアリングファイル（モード設定に関わらず）

### 3. 検証の実行

各タスクについて確認する:

#### タスク完了チェック
- tasks.md のチェックボックスが `[x]` である
- 完了していない場合、「タスクが完了マークされていない」としてフラグを立てる

#### テストカバレッジチェック
- タスク関連機能のテストが存在する
- テストが合格する（失敗やエラーなし）
- テストコマンドを実行するためにBashを使用する（例: `npm test`, `pytest`）
- テストが失敗するか存在しない場合、「テストカバレッジの問題」としてフラグを立てる

#### 要件トレーサビリティ
- タスクに関連するEARS要件を特定する
- 要件カバレッジの証拠について実装を検索するためにGrepを使用する
- 要件がコードに追跡できない場合、「要件が実装されていない」としてフラグを立てる

#### 設計整合性
- design.md の構造が実装に反映されているか確認する
- 主要なインターフェース、コンポーネント、モジュールが存在することを確認する
- ファイル構造が設計と一致することを確認するためにGrep/LSを使用する
- 不整合が見つかった場合、「設計からの逸脱」としてフラグを立てる

#### リグレッションチェック
- 完全なテストスイートを実行する（利用可能な場合）
- 既存のテストが壊れていないことを検証する
- リグレッションが検出された場合、「リグレッション検出」としてフラグを立てる

### 4. レポート生成

spec.json で指定された言語で要約を提供する:
- 機能ごとの検証要約
- カバレッジレポート（タスク、要件、設計）
- 重要度付きの問題と逸脱（Critical/Warning）
- GO/NO-GO 決定

## 重要な制約
- **会話認識**: 自動検出のために会話履歴を優先する
- **非ブロッキング警告**: 設計からの逸脱は、クリティカルでない限り警告とする
- **テストファースト**: テストカバレッジはGO決定に必須である
- **トレーサビリティ必須**: すべての要件は実装に追跡可能でなければならない
</instructions>

## ツールガイダンス
- **Conversation parsing**: 履歴から `/kiro:spec-impl` パターンを抽出する
- **Read context**: 検証前にすべての仕様とステアリングをロードする
- **Bash for tests**: 合格状態を検証するためにテストコマンドを実行する
- **Grep for traceability**: 要件の証拠についてコードベースを検索する
- **LS/Glob for structure**: ファイル構造が設計と一致することを確認する

## 出力記述

spec.json で指定された言語で以下を提供する:

1. **検出されたターゲット**: 検証されている機能とタスク（自動検出された場合）
2. **検証要約**: 機能ごとの短い概要（合格/失敗数）
3. **問題**: 重要度と場所を含む検証失敗のリスト
4. **カバレッジレポート**: 要件/設計/タスクのカバレッジ率
5. **決定**: GO（次のフェーズの準備完了） / NO-GO（修正が必要）

**フォーマット要件**:
- 明確さのためにMarkdown見出しとテーブルを使用する
- 重要な問題には ⚠️ または 🔴 でフラグを立てる
- 要約を簡潔に保つ（400語以内）

## 安全性とフォールバック

### エラーシナリオ
- **実装が見つからない**: 履歴に `/kiro:spec-impl` がなく、`[x]` タスクもない場合、「実装が検出されません」と報告する
- **テストコマンド不明**: テストフレームワークが不明確な場合、警告してテスト検証をスキップする（手動検証が必要）
- **仕様ファイル欠落**: spec.json/requirements.md/design.md が欠落している場合、エラーで停止する
- **言語未定義**: spec.json で言語が指定されていない場合、英語 (`en`) をデフォルトとする

### 次のステップガイダンス

**GO 決定の場合**:
- 実装が検証され準備完了
- デプロイまたは次の機能に進む

**NO-GO 決定の場合**:
- リストされた重要な問題に対処する
- 修正のために `/kiro:spec-impl <feature> [tasks]` を再実行する
- `/kiro:validate-impl [feature] [tasks]` で再検証する

**ノート**: 仕様との整合性と品質を確保するために、実装後の検証が推奨される。

arguments: {{args}}
"""