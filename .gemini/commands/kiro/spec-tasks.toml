description = "仕様書の技術設計から実装タスクを生成する"
prompt = """
<meta>
description: 仕様書の技術設計から実装タスクを生成する
argument-hint: <feature-name:$1> [-y:$2] [--sequential:$3]
arguments: {{args}}
</meta>

# 実装タスクジェネレーター (Implementation Tasks Generator)

<background_information>
- **ミッション**: 技術設計を実行可能な作業項目に変換する、詳細でアクション可能な実装タスクを生成する
- **成功基準**:
  - すべての要件が特定のタスクにマッピングされている
  - タスクが適切にサイズ調整されている（各1〜3時間）
  - 適切な階層を持つ明確なタスク進行
  - 能力に焦点を当てた自然言語記述
</background_information>

<instructions>
## コアタスク
承認された要件と設計に基づいて、機能 **$1** の実装タスクを生成する。

## 実行ステップ

### ステップ 1: コンテキストのロード

**必要なすべてのコンテキストを読み込む**:
- `.kiro/specs/$1/spec.json`, `requirements.md`, `design.md`
- `.kiro/specs/$1/tasks.md` (存在する場合、マージモード用)
- **`.kiro/steering/` ディレクトリ全体**（完全なプロジェクトメモリのため）

**承認の検証**:
- `-y` フラグが提供された場合 ($2 == "-y"): spec.json 内の要件と設計を自動承認する
- それ以外の場合: 両方が承認されていることを確認する（未承認の場合は停止、安全性とフォールバックを参照）
- シーケンシャルモードを決定する: `sequential = ($3 == "--sequential")`

### ステップ 2: 実装タスクの生成

**生成ルールとテンプレートのロード**:
- 原則のために `.kiro/settings/rules/tasks-generation.md` を読む
- `sequential == false` の場合: 並行判断基準のために `.kiro/settings/rules/tasks-parallel-analysis.md` を読む
- フォーマットのために `.kiro/settings/templates/specs/tasks.md` を読む（`(P)` マーカーをサポート）

**すべてのルールに従ってタスクリストを生成する**:
- spec.json で指定された言語を使用する
- すべての要件をタスクにマップし、数値の要件IDのみをリストする（カンマ区切り）。余分なナレーション、説明的なサフィックス、括弧、翻訳、または自由形式のラベルを付けないこと。
- すべての設計コンポーネントが含まれていることを確認する
- タスクの進行が論理的かつ段階的であることを検証する
- 単一サブタスクの構造を折りたたみ、それらを主要タスクに昇格させ、コンテナの要約を簡潔に保つ
- 並行基準を満たすタスクに `(P)` マーカーを適用する（`sequential == true` の場合はマーカーをスキップ）
- 受け入れ基準に焦点を当てたテストカバレッジのサブタスクは、MVP後に延期可能な場合にのみ、オプションとして `- [ ]*` でマークする
- 既存の tasks.md が見つかった場合、新しいコンテンツとマージする

### ステップ 3: 完了

**書き込みと更新**:
- `.kiro/specs/$1/tasks.md` を作成/更新する
- spec.json メタデータを更新する:
  - `phase: "tasks-generated"` を設定
  - `approvals.tasks.generated: true, approved: false` を設定
  - `approvals.requirements.approved: true` を設定
  - `approvals.design.approved: true` を設定
  - `updated_at` タイムスタンプを更新

## 重要な制約
- **ルールに厳密に従う**: tasks-generation.md のすべての原則は必須である
- **自然言語**: コード構造の詳細ではなく、何をするかを記述する
- **完全なカバレッジ**: すべての要件がタスクにマップされなければならない
- **最大2レベル**: 主要タスクとサブタスクのみ（これ以上の深いネストなし）
- **連続番号付け**: 主要タスクは増加し（1, 2, 3...）、決して繰り返さない
- **タスク統合**: すべてのタスクはシステムに接続しなければならない（孤立した作業なし）
</instructions>

## ツールガイダンス
- **Read first**: 生成前にすべてのコンテキスト、ルール、テンプレートをロードする
- **Write last**: 完全な分析と検証の後にのみ tasks.md を生成する

## 出力記述

spec.json で指定された言語で短い要約を提供する:

1. **ステータス**: `.kiro/specs/$1/tasks.md` でタスクが生成されたことを確認
2. **タスク要約**: 
   - 合計: X 主要タスク, Y サブタスク
   - 全 Z 要件をカバー
   - 平均タスクサイズ: サブタスクあたり1〜3時間
3. **品質検証**:
   - ✅ すべての要件がタスクにマップされた
   - ✅ タスク依存関係が検証された
   - ✅ テストタスクが含まれている
4. **次のアクション**: タスクをレビューし、準備ができたら進める

**フォーマット**: 簡潔（200語以内）

## 安全性とフォールバック

### エラーシナリオ

**要件または設計が承認されていない**:
- **実行停止**: 承認された要件と設計なしで進めることはできない
- **ユーザーメッセージ**: "タスク生成の前に要件と設計が承認されている必要があります"
- **提案アクション**: "両方を自動承認して進めるには `/kiro:spec-tasks $1 -y` を実行してください"

**要件または設計の欠落**:
- **実行停止**: 両方のドキュメントが存在する必要がある
- **ユーザーメッセージ**: "`.kiro/specs/$1/` に requirements.md または design.md が見つかりません"
- **提案アクション**: "最初に要件と設計フェーズを完了してください"

**不完全な要件カバレッジ**:
- **警告**: "すべての要件がタスクにマップされていません。カバレッジを確認してください。"
- **ユーザーアクション必須**: 意図的なギャップを確認するか、タスクを再生成する

**テンプレート/ルール欠落**:
- **ユーザーメッセージ**: "`.kiro/settings/` にテンプレートまたはルールファイルがありません"
- **フォールバック**: 警告付きでインライン基本構造を使用する
- **提案アクション**: "リポジトリのセットアップを確認するか、テンプレートファイルを復元してください"
- **数値要件IDの欠落**:
  - **実行停止**: requirements.md 内のすべての要件は数値IDを持たなければならない。数値IDが欠落している要件がある場合、停止して、タスクを生成する前に requirements.md を修正するよう要求する。

### 次のフェーズ: 実装

**実装を開始する前に**:
- **重要**: `/kiro:spec-impl` を実行する前に、会話履歴をクリアし、コンテキストを解放する
- これは最初のタスクを開始するとき、またはタスク間を切り替えるときに適用される
- 新鮮なコンテキストは、クリーンな状態と適切なタスクの焦点を保証する

**タスクが承認された場合**:
- 特定のタスクを実行: `/kiro:spec-impl $1 1.1` (推奨: 各タスク間でコンテキストをクリア)
- 複数のタスクを実行: `/kiro:spec-impl $1 1.1,1.2` (注意して使用、タスク間でコンテキストをクリア)
- 引数なし: `/kiro:spec-impl $1` (すべての保留中タスクを実行 - コンテキスト肥大化のため推奨されない)

**修正が必要な場合**:
- フィードバックを提供し、`/kiro:spec-tasks $1` を再実行する
- 既存のタスクは参照として使用される（マージモード）

**ノート**: 実装フェーズでは、適切なコンテキストと検証を使用してタスクを実行するようにガイドされる。

arguments: {{args}}
"""