description = "仕様書の包括的な要件を生成する"
prompt = """
<meta>
description: 仕様書の包括的な要件を生成する
argument-hint: <feature-name:$1>
arguments: {{args}}
</meta>

# 要件生成 (Requirements Generation)

<background_information>
- **ミッション**: 仕様初期化からのプロジェクト記述に基づいて、EARSフォーマットで包括的かつテスト可能な要件を生成する
- **成功基準**:
  - ステアリングコンテキストと整合した完全な要件ドキュメントを作成する
  - すべての受け入れ基準についてプロジェクトのEARSパターンと制約に従う
  - 実装の詳細なしでコア機能に焦点を当てる
  - 生成ステータスを追跡するためにメタデータを更新する
</background_information>

<instructions>
## コアタスク
requirements.md 内のプロジェクト記述に基づいて、機能 **$1** の完全な要件を生成する。

## 実行ステップ

1. **コンテキストのロード**:
   - 言語とメタデータのために `.kiro/specs/$1/spec.json` を読み込む
   - プロジェクト記述のために `.kiro/specs/$1/requirements.md` を読み込む
   - **すべてのステアリングコンテキストをロード**: `.kiro/steering/` ディレクトリ全体を読み込む:
     - デフォルトファイル: `structure.md`, `tech.md`, `product.md`
     - すべてのカスタムステアリングファイル（モード設定に関わらず）
     - これにより完全なプロジェクトメモリとコンテキストが提供される

2. **ガイドラインの読み込み**:
   - EARS構文ルールのために `.kiro/settings/rules/ears-format.md` を読み込む
   - ドキュメント構造のために `.kiro/settings/templates/specs/requirements.md` を読み込む

3. **要件の生成**:
   - プロジェクト記述に基づいて初期要件を作成する
   - 関連する機能を論理的な要件エリアにグループ化する
   - すべての受け入れ基準にEARSフォーマットを適用する
   - `spec.json` で指定された言語を使用する

4. **メタデータの更新**:
   - `phase: "requirements-generated"` を設定する
   - `approvals.requirements.generated: true` を設定する
   - `updated_at` タイムスタンプを更新する

## 重要な制約
- HOW（どうやって）ではなく、WHAT（何を）に焦点を当てる（実装の詳細はなし）
- 要件はテスト可能で検証可能でなければならない
- EARSステートメントに適切な主語を選択する（ソフトウェアの場合はシステム/サービス名）
- 最初に初期バージョンを生成し、その後ユーザーフィードバックで反復する（事前に連続して質問しない）
- requirements.md の要件見出しには、先頭に数値IDのみを含める必要がある（例：「要件 1」、「1.」、「2 機能...」）。「要件 A」のようなアルファベットIDは使用しないこと。
</instructions>

## ツールガイダンス
- **Read first**: 生成前にすべてのコンテキスト（仕様、ステアリング、ルール、テンプレート）をロードする
- **Write last**: 完全な生成後にのみ requirements.md を更新する
- **WebSearch/WebFetch**: 外部ドメイン知識が必要な場合のみ使用する

## 出力記述
`spec.json` で指定された言語で以下を提供する:

1. **生成された要件要約**: 主要な要件エリアの短い概要（3〜5箇条書き）
2. **ドキュメントステータス**: requirements.md の更新と spec.json メタデータの更新を確認
3. **次のステップ**: ユーザーに進め方を案内する（承認して続行、または修正）

**フォーマット要件**:
- 明確さのためにMarkdown見出しを使用する
- コードブロックにファイルパスを含める
- 要約を簡潔に保つ（300語以内）

## 安全性とフォールバック

### エラーシナリオ
- **プロジェクト記述欠落**: requirements.md にプロジェクト記述がない場合、ユーザーに機能の詳細を尋ねる
- **曖昧な要件**: 多くの事前質問をするのではなく、初期バージョンを提案してユーザーと反復する
- **テンプレート欠落**: テンプレートファイルが存在しない場合、警告付きでインラインフォールバック構造を使用する
- **言語未定義**: spec.json で言語が指定されていない場合、英語 (`en`) をデフォルトとする
- **不完全な要件**: 生成後、要件がすべての期待される機能をカバーしているか明示的にユーザーに尋ねる
- **ステアリングディレクトリ空**: プロジェクトコンテキストが欠落しており要件の質に影響する可能性があることをユーザーに警告する
- **非数値の要件見出し**: 既存の見出しが先頭に数値IDを含まない場合（例：「要件 A」を使用している）、それらを数値IDに正規化し、そのマッピングを一貫させる（数値とアルファベットのラベルを決して混在させない）。

### 次のフェーズ: 設計生成

**要件が承認された場合**:
- `.kiro/specs/$1/requirements.md` で生成された要件をレビューする
- **オプションのギャップ分析**（既存のコードベース向け）:
  - `/kiro:validate-gap $1` を実行して現在のコードとの実装ギャップを分析する
  - 既存のコンポーネント、統合ポイント、実装戦略を特定する
  - ブラウンフィールドプロジェクトに推奨; グリーンフィールドの場合はスキップ
- その後 `/kiro:spec-design $1 -y` で設計フェーズに進む

**修正が必要な場合**:
- フィードバックを提供し、`/kiro:spec-requirements $1` を再実行する

**ノート**: 設計フェーズに進む前に承認が必須である。

arguments: {{args}}
"""