description = "仕様書の包括的な技術設計を作成する"
prompt = """
<meta>
description: 仕様書の包括的な技術設計を作成する
argument-hint: <feature-name:$1> [-y:$2]
arguments: {{args}}
</meta>

# 技術設計ジェネレーター (Technical Design Generator)

<background_information>
- **ミッション**: 要件 (WHAT) をアーキテクチャ設計 (HOW) に変換する包括的な技術設計ドキュメントを生成する
- **成功基準**:
  - すべての要件が明確なインターフェースを持つ技術コンポーネントにマッピングされている
  - 適切なアーキテクチャ調査とリサーチが完了している
  - 設計がステアリングコンテキストと既存のパターンと整合している
  - 複雑なアーキテクチャには視覚的な図が含まれている
</background_information>

<instructions>
## コアタスク
承認された要件に基づいて、機能 **$1** の技術設計ドキュメントを生成する。

## 実行ステップ

### ステップ 1: コンテキストのロード

**必要なすべてのコンテキストを読み込む**:
- `.kiro/specs/$1/spec.json`, `requirements.md`, `design.md` (存在する場合)
- **`.kiro/steering/` ディレクトリ全体**（完全なプロジェクトメモリのため）
- `.kiro/settings/templates/specs/design.md`（ドキュメント構造のため）
- `.kiro/settings/rules/design-principles.md`（設計原則のため）
- `.kiro/settings/templates/specs/research.md`（調査ログ構造のため）

**要件承認の検証**:
- `-y` フラグが提供された場合 ($2 == "-y"): spec.json 内の要件を自動承認する
- それ以外の場合: 承認ステータスを確認する（未承認の場合は停止、安全性とフォールバックを参照）

### ステップ 2: 調査と分析 (Discovery & Analysis)

**重要: このフェーズは、設計が完全で正確な情報に基づいていることを保証する。**

1. **機能タイプの分類**:
   - **新機能** (Greenfield) → 完全な調査が必要
   - **拡張** (Existing system) → 統合重視の調査
   - **単純な追加** (CRUD/UI) → 最小限または調査なし
   - **複雑な統合** → 包括的な分析が必要

2. **適切な調査プロセスの実行**:
   
   **複雑/新機能の場合**:
   - `.kiro/settings/rules/design-discovery-full.md` を読み込み実行する
   - WebSearch/WebFetchを使用して徹底的なリサーチを行う:
     - 最新のアーキテクチャパターンとベストプラクティス
     - 外部依存関係の検証（API、ライブラリ、バージョン、互換性）
     - 公式ドキュメント、移行ガイド、既知の問題
     - パフォーマンスベンチマークとセキュリティの考慮事項
   
   **拡張の場合**:
   - `.kiro/settings/rules/design-discovery-light.md` を読み込み実行する
   - 統合ポイント、既存のパターン、互換性に焦点を当てる
   - Grepを使用して既存のコードベースパターンを分析する
   
   **単純な追加の場合**:
   - 正式な調査をスキップし、クイックなパターンチェックのみ行う

3. **ステップ3のために調査結果を保持する**:
   - 外部API契約と制約
   - 根拠を伴う技術決定
   - 従うべき、または拡張すべき既存のパターン
   - 統合ポイントと依存関係
   - 特定されたリスクと緩和戦略
   - 潜在的なアーキテクチャパターンと境界オプション (`research.md` に詳細を記録)
   - 将来のタスクのための並列化の考慮事項 (`research.md` に依存関係をキャプチャ)

4. **調査ログへの結果の保存**:
   - 共有テンプレートを使用して `.kiro/specs/$1/research.md` を作成または更新する
   - 調査スコープと主要な発見事項を要約する（要約セクション）
   - ソースと含意を添えて調査をリサーチログトピックに記録する
   - テンプレートセクションを使用してアーキテクチャパターン評価、設計決定、リスクを文書化する
   - `research.md` を記述または更新する際は、spec.json で指定された言語を使用する

### ステップ 3: 設計ドキュメントの生成

1. **設計テンプレートとルールのロード**:
   - 構造のために `.kiro/settings/templates/specs/design.md` を読む
   - 原則のために `.kiro/settings/rules/design-principles.md` を読む

2. **設計ドキュメントの生成**:
   - **specs/design.md テンプレート構造と生成指示に厳密に従う**
   - **すべての調査結果を統合する**: コンポーネント定義、アーキテクチャ決定、統合ポイント全体で調査情報（API、パターン、技術）を使用する
   - ステップ1で既存の design.md が見つかった場合、参照コンテキストとして使用する（マージモード）
   - 設計ルールを適用する: 型安全性、視覚的コミュニケーション、フォーマルなトーン
   - spec.json で指定された言語を使用する
   - セクションが更新された見出し（「アーキテクチャパターン & 境界マップ」、「技術スタック & アライメント」、「コンポーネント & インターフェース契約」）を反映していることを確認し、`research.md` からの補足詳細を参照する

3. **メタデータの更新** (spec.json):
   - `phase: "design-generated"` を設定
   - `approvals.design.generated: true, approved: false` を設定
   - `approvals.requirements.approved: true` を設定
   - `updated_at` タイムスタンプを更新

## 重要な制約
 - **型安全性**:
   - プロジェクトの技術スタックに合わせた強力な型付けを強制する。
   - 静的型付け言語の場合、明示的な型/インターフェースを定義し、安全でないキャストを避ける。
   - TypeScriptの場合、決して `any` を使用せず、正確な型とジェネリクスを優先する。
   - 動的型付け言語の場合、利用可能な場所で型ヒント/アノテーション（例：Python型ヒント）を提供し、境界で入力を検証する。
   - コンポーネント間の型安全性を確保するために、パブリックインターフェースと契約を明確に文書化する。
- **最新情報**: 外部依存関係とベストプラクティスには WebSearch/WebFetch を使用する
- **ステアリング整合性**: ステアリングコンテキストからの既存のアーキテクチャパターンを尊重する
- **テンプレート遵守**: specs/design.md テンプレート構造と生成指示に厳密に従う
- **設計の焦点**: アーキテクチャとインターフェースのみ、実装コードなし
- **要件トレーサビリティID**: requirements.md で定義された通りの数値要件ID（例：「1.1」、「1.2」、「3.1」、「3.3」）のみを使用する。新しいIDを発明したり、アルファベットのラベルを使用したりしないこと。

### 言語リマインダー
- Markdownスタイルのプロンプト内容は英語のままであるべきですが、spec.json が設計出力に別の言語を要求している場合、生成される design.md と research.md はその仕様言語を使用する必要があります。
</instructions>

## ツールガイダンス
- **Read first**: アクションを起こす前にすべてのコンテキストをロードする（仕様、ステアリング、テンプレート、ルール）
- **Research when uncertain**: 外部依存関係、API、最新のベストプラクティスについては WebSearch/WebFetch を使用する
- **Analyze existing code**: コードベース内のパターンと統合ポイントを見つけるために Grep を使用する
- **Write last**: すべてのリサーチと分析が完了した後にのみ design.md を生成する

## 出力記述

**コマンド実行出力** (design.md コンテンツとは別):

spec.json で指定された言語で短い要約を提供する:

1. **ステータス**: `.kiro/specs/$1/design.md` で設計ドキュメントが生成されたことを確認
2. **調査タイプ**: どの調査プロセスが実行されたか（full/light/minimal）
3. **主要な発見事項**: 設計を形成した調査からの2-3の重要な洞察
4. **次のアクション**: 承認ワークフローガイダンス（安全性とフォールバックを参照）

**フォーマット**: 簡潔なMarkdown（200語以内） - これはコマンド出力であり、設計ドキュメントそのものではない

**ノート**: 実際の設計ドキュメントは `.kiro/settings/templates/specs/design.md` 構造に従う。

## 安全性とフォールバック

### エラーシナリオ

**要件が承認されていない**:
- **実行停止**: 承認された要件なしで進めることはできない
- **ユーザーメッセージ**: "要件はまだ承認されていません。設計生成の前に承認が必要です。"
- **提案アクション**: "要件を自動承認して進めるには `/kiro:spec-design $1 -y` を実行してください"

**要件欠落**:
- **実行停止**: 要件ドキュメントが存在する必要がある
- **ユーザーメッセージ**: "`.kiro/specs/$1/requirements.md` に requirements.md が見つかりません"
- **提案アクション**: "最初に要件を生成するために `/kiro:spec-requirements $1` を実行してください"

**テンプレート欠落**:
- **ユーザーメッセージ**: "`.kiro/settings/templates/specs/design.md` にテンプレートファイルがありません"
- **提案アクション**: "リポジトリのセットアップを確認するか、テンプレートファイルを復元してください"
- **フォールバック**: 警告付きでインライン基本構造を使用する

**ステアリングコンテキスト欠落**:
- **警告**: "ステアリングディレクトリが空または欠落しています - 設計がプロジェクト標準に合わない可能性があります"
- **続行**: 生成を続行するが、出力に制限を注記する

**調査の複雑さが不明確**:
- **デフォルト**: 完全な調査プロセス (`.kiro/settings/rules/design-discovery-full.md`) を使用する
- **根拠**: 重要なコンテキストを見逃すよりは過剰に調査する方が良い
- **無効な要件ID**:
  - **実行停止**: requirements.md に数値IDが欠落しているか、非数値の見出し（例：「要件 A」）が使用されている場合、停止して、続行する前に requirements.md を修正するようユーザーに指示する。

### 次のフェーズ: タスク生成

**設計が承認された場合**:
- `.kiro/specs/$1/design.md` で生成された設計をレビューする
- **オプション**: インタラクティブな品質レビューのために `/kiro:validate-design $1` を実行する
- その後、実装タスクを生成するために `/kiro:spec-tasks $1 -y` を実行する

**修正が必要な場合**:
- フィードバックを提供し、`/kiro:spec-design $1` を再実行する
- 既存の設計は参照として使用される（マージモード）

**ノート**: タスク生成に進む前に設計承認が必須である。

arguments: {{args}}
"""