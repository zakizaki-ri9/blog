# データベース標準

[目的: スキーマ設計、クエリ、マイグレーション、および整合性のガイド]

## 哲学
- ドメインを最初にモデル化する; 正しさの後に最適化する
- 明示的な制約を優先する; データベースに不変条件を強制させる
- 必要なものだけをクエリする; 最適化の前に測定する

## 命名 & 型
- テーブル: `snake_case`, 複数形 (`users`, `order_items`)
- カラム: `snake_case` (`created_at`, `user_id`)
- 外部キー: `{table}_id` で `{table}.id` を参照
- 型: タイムゾーン認識タイムスタンプ; 強力なID; 正確な金額型

## 関係
- 1:N: 子に外部キー
- N:N: 複合キーを持つ結合テーブル
- 1:1: 外部キー + UNIQUE

## マイグレーション
- 不変なマイグレーション; 常にロールバックを追加する
- 小さく、焦点の絞られたステップ; 最初に非本番環境でテストする
- 命名: `{seq}_{action}_{object}` (例: `002_add_email_index`)

## クエリパターン
- 単純なCRUDと安全性のためのORM; 複雑/パフォーマンス重視のための生のSQL
- N+1を避ける (eager load/batching); 大きなセットをページネートする
- 外部キーと頻繁にフィルタ/ソートされるカラムにインデックスを付ける

## 接続 & トランザクション
- プーリングを使用する（ワークロードに基づくサイズ/タイムアウト）
- 作業単位ごとに1つの接続; 速やかに閉じる/返す
- 複数ステップの変更をトランザクションでラップする

## データ整合性
- NOT NULL/UNIQUE/CHECK/FK 制約を使用する
- 適切な場合DBで検証する（多層防御）
- 一貫した派生のために生成カラムを優先する

## バックアップ & リカバリ
- 保持期間付きの定期バックアップ; リストアのテスト
- RPO/RTO目標の文書化; バックアップジョブの監視

---
_パターンと決定に焦点を当てる。環境固有の設定なし。_