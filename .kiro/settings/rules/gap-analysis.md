# ギャップ分析プロセス

## 目的
実装戦略の決定に役立てるため、要件と既存のコードベースとの間のギャップを分析する。

## 分析フレームワーク

### 1. 現状調査

- ドメイン関連資産のスキャン:
  - 主要ファイル/モジュールとディレクトリ構成
  - 再利用可能なコンポーネント/サービス/ユーティリティ
  - 支配的なアーキテクチャパターンと制約

- 規約の抽出:
  - 命名、階層化、依存の方向性
  - インポート/エクスポートパターンと依存のホットスポット
  - テストの配置とアプローチ

- 統合表面の記録:
  - データモデル/スキーマ、APIクライアント、認証メカニズム

### 2. 要件実現可能性分析

- EARS要件から技術的ニーズをリストアップ:
  - データモデル、API/サービス、UI/コンポーネント
  - ビジネスルール/バリデーション
  - 非機能要件: セキュリティ、パフォーマンス、スケーラビリティ、信頼性

- ギャップと制約の特定:
  - 現在のコードベースに欠けている機能
  - 後で調査が必要な未知事項（「要調査」としてマーク）
  - 既存のアーキテクチャとパターンからの制約

- 複雑さのシグナルを記録:
  - 単純なCRUD / アルゴリズムロジック / ワークフロー / 外部統合

### 3. 実装アプローチの選択肢

#### オプションA: 既存コンポーネントの拡張
**検討すべき場合**: 機能が既存の構造に自然に適合する場合

- **拡張するファイル/モジュール**:
  - 変更が必要な具体的なファイルを特定
  - 既存機能への影響を評価
  - 後方互換性の懸念を評価

- **互換性評価**:
  - 拡張が既存のインターフェースを尊重しているか確認
  - コンシューマーに対する破壊的変更がないか検証
  - テストカバレッジへの影響を評価

- **複雑さと保守性**:
  - 追加機能による認知的負荷を評価
  - 単一責任の原則が維持されているか確認
  - ファイルサイズが管理可能なままであるか評価

**トレードオフ**:
- ✅ 新規ファイルが最小限、初期開発が速い
- ✅ 既存のパターンとインフラを活用できる
- ❌ 既存コンポーネントが肥大化するリスク
- ❌ 既存ロジックを複雑にする可能性がある

#### オプションB: 新規コンポーネントの作成
**検討すべき場合**: 機能が明確に異なる責任を持つか、既存コンポーネントがすでに複雑な場合

- **新規作成の根拠**:
  - 関心の明確な分離が新規ファイルを正当化する
  - 既存コンポーネントがすでに複雑である
  - 機能が独自のライフサイクルまたは依存関係を持つ

- **統合ポイント**:
  - 新規コンポーネントが既存システムとどう接続するか
  - 公開されるAPIまたはインターフェース
  - 既存コンポーネントへの依存

- **責任の境界**:
  - 新規コンポーネントが所有するものの明確な定義
  - 既存コンポーネントとのインターフェース
  - データフローと制御フロー

**トレードオフ**:
- ✅ 関心のきれいな分離
- ✅ 隔離してテストしやすい
- ✅ 既存コンポーネントの複雑さを軽減
- ❌ ナビゲートするファイルが増える
- ❌ 慎重なインターフェース設計が必要

#### オプションC: ハイブリッドアプローチ
**検討すべき場合**: 拡張と新規作成の両方を必要とする複雑な機能

- **組み合わせ戦略**:
  - どの部分が既存コンポーネントを拡張するか
  - どの部分が新規コンポーネントを正当化するか
  - それらがどう相互作用するか

- **段階的実装**:
  - 初期フェーズ: 最小限の実行可能な変更
  - 後続フェーズ: リファクタリングまたは新規コンポーネント
  - 必要に応じた移行戦略

- **リスク緩和**:
  - 段階的なロールアウトアプローチ
  - 機能フラグまたは設定
  - ロールバック戦略

**トレードオフ**:
- ✅ 複雑な機能に対するバランスの取れたアプローチ
- ✅ 反復的な改善が可能
- ❌ より複雑な計画が必要
- ❌ 調整が不十分だと不整合が生じる可能性がある

### 4. ギャップ分析のスコープ外

- 深い調査活動は設計フェーズに延期する。
- 未知事項は簡潔な「要調査」項目としてのみ記録する。

### 5. 実装の複雑さとリスク

  - 工数 (Effort):
    - S (1–3日): 既存パターン、最小限の依存、素直な統合
    - M (3–7日): いくつかの新パターン/統合、中程度の複雑さ
    - L (1–2週間): 重要な機能、複数の統合またはワークフロー
    - XL (2週間以上): アーキテクチャ変更、不慣れな技術、広範な影響
  - リスク (Risk):
    - High: 未知の技術、複雑な統合、アーキテクチャの変更、不明確なパフォーマンス/セキュリティパス
    - Medium: ガイダンス付きの新パターン、管理可能な統合、既知のパフォーマンス解決策
    - Low: 確立されたパターンの拡張、慣れた技術、明確なスコープ、最小限の統合

### 出力チェックリスト

- ギャップがタグ付けされた要件対資産マップ（欠落 / 未知 / 制約）
- オプションA/B/Cと短い根拠およびトレードオフ
- 工数 (S/M/L/XL) とリスク (High/Medium/Low) とそれぞれ1行の正当化
- 設計フェーズへの推奨事項:
  - 優先されるアプローチと主要な決定事項
  - 持ち越す調査項目

## 原則

- **決定より情報**: 最終的な選択ではなく、分析と選択肢を提供する
- **複数の実行可能な選択肢**: 該当する場合は信頼できる代替案を提示する
- **明示的なギャップと前提**: 未知事項と制約を明確にフラグ立てする
- **コンテキスト認識**: 既存のパターンとアーキテクチャの制限に合わせる
- **透明性のある工数とリスク**: ラベルを簡潔に正当化する